import pandas as pd
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import seaborn as sns

# Cargar dataset

data = pd.read_excel("IA_3.xlsx")
print("Tamaño del dataset:", data.shape)
print(data.head())


print("\nConteo EMBARAZO (0=no, 1=sí, 2=posible):")
print(data["EMBARAZO"].value_counts(dropna=False))

# variables independientes

X = data[["EDAD", "CICLO_REGULAR", "USO_ANTICONCEPTIVOS", "RELACIONES_ACTIVAS"]]


# Escalar datos
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# Clustering KMeans

kmeans = KMeans(n_clusters=3, random_state=42, n_init=10)
clusters = kmeans.fit_predict(X_scaled)
data["CLUSTER"] = clusters

print("\nConteo por cluster:")
print(data["CLUSTER"].value_counts())

#  PCA para visualizar clusters

pca = PCA(n_components=2, random_state=42)
componentes = pca.fit_transform(X_scaled)

data["PC1"] = componentes[:, 0]
data["PC2"] = componentes[:, 1]

plt.figure(figsize=(5,5))
sns.scatterplot(
    x="PC1", y="PC2",
    hue="CLUSTER",
    palette="Set1",
    data=data,
    s=40,
    alpha=0.8
)
plt.title("Clusters usando PCA (KMeans)")
plt.xlabel("Componente Principal 1")
plt.ylabel("Componente Principal 2")
plt.legend(title="Cluster")
plt.grid(True)
plt.tight_layout()
plt.show()

# Heatmap EMBARAZO vs CLUSTER

ct = pd.crosstab(data["EMBARAZO"], data["CLUSTER"])
print("\nCrosstab EMBARAZO vs CLUSTER:\n", ct)

plt.figure(figsize=(6,4))
sns.heatmap(ct, annot=True, fmt="d", cmap="Blues")
plt.xlabel("Cluster (KMeans)")
plt.ylabel("EMBARAZO (0=no,1=sí,2=posible)")
plt.title("Mapa de Calor: EMBARAZO vs Clusters Descubiertos")
plt.tight_layout()
plt.show()

#  Estadísticas descriptivas por cluster

print("\nPromedio de variables por cluster:")
print(
    data.groupby("CLUSTER")[["EDAD","CICLO_REGULAR","USO_ANTICONCEPTIVOS","RELACIONES_ACTIVAS"]]
    .mean()
)

print("\nConteos EMBARAZO por cluster:")
print(pd.crosstab(data["CLUSTER"], data["EMBARAZO"]))

# Guardar resultados
# # ==========================
# data.to_excel("resultado_clusters.xlsx", index=False)
# print("\nArchivo generado: resultado_clusters.xlsx")
